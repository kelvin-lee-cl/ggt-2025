<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Lesson - Educational Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/fa/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <style>
        /* Dark mode: Force white text for all lesson content */
        [data-theme="dark"] .container,
        [data-theme="dark"] .container * {
            color: white !important;
        }

        [data-theme="dark"] .text-muted {
            color: rgba(255, 255, 255, 0.7) !important;
        }

        [data-theme="dark"] .text-primary {
            color: #64d2e2 !important;
        }

        [data-theme="dark"] .text-success {
            color: #28a745 !important;
        }

        [data-theme="dark"] .text-warning {
            color: #ffc107 !important;
        }

        [data-theme="dark"] .text-info {
            color: #17a2b8 !important;
        }

        [data-theme="dark"] .card {
            background-color: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        [data-theme="dark"] .accordion-item {
            background-color: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        [data-theme="dark"] .accordion-button {
            background-color: rgba(255, 255, 255, 0.1) !important;
            color: white !important;
        }

        [data-theme="dark"] .accordion-button:not(.collapsed) {
            background-color: rgba(100, 210, 226, 0.2) !important;
            color: white !important;
        }

        [data-theme="dark"] pre {
            background-color: rgba(0, 0, 0, 0.3) !important;
            color: white !important;
        }

        [data-theme="dark"] .border {
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        [data-theme="dark"] .btn {
            color: white !important;
        }

        [data-theme="dark"] .btn-outline-primary {
            color: #64d2e2 !important;
            border-color: #64d2e2 !important;
        }

        [data-theme="dark"] .btn-outline-primary:hover {
            background-color: #64d2e2 !important;
            color: white !important;
        }

        [data-theme="dark"] .btn-outline-info {
            color: #17a2b8 !important;
            border-color: #17a2b8 !important;
        }

        [data-theme="dark"] .btn-outline-info:hover {
            background-color: #17a2b8 !important;
            color: white !important;
        }

        [data-theme="dark"] .btn-outline-success {
            color: #28a745 !important;
            border-color: #28a745 !important;
        }

        [data-theme="dark"] .btn-outline-success:hover {
            background-color: #28a745 !important;
            color: white !important;
        }

        [data-theme="dark"] .btn-outline-secondary {
            color: #6c757d !important;
            border-color: #6c757d !important;
        }

        [data-theme="dark"] .btn-outline-secondary:hover {
            background-color: #6c757d !important;
            color: white !important;
        }
    </style>
</head>

<body>
    <!-- Shared Navbar -->
    <div id="navbar-root"></div>

    <!-- Main Content -->
    <div class="container mt-5 pt-5">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <!-- Lesson Header -->
                <div class="text-center mb-5">
                    <h1 class="display-6 fw-bold text-primary" id="lessonTitle">Loading...</h1>
                    <p class="lead text-muted" id="lessonSubtitle">Loading...</p>
                    <div class="mb-3">
                        <span class="badge" id="lessonStatusBadge">Loading...</span>
                    </div>
                </div>

                <!-- Lesson Content -->
                <div id="lessonContent">
                    <!-- Content will be loaded here -->
                </div>

                <!-- Lesson Actions -->
                <div class="card shadow-soft">
                    <div class="card-body text-center">
                        <h5 class="mb-3" id="actionTitle">Loading...</h5>
                        <p class="text-muted mb-4" id="actionDescription">Loading...</p>
                        <div class="d-flex justify-content-center gap-3 flex-wrap" id="actionButtons">
                            <!-- Action buttons will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="navbar.js"></script>
    <script src="script.js"></script>
    <script src="quiz-popup.js"></script>
    <script src="exercise-submission.js"></script>
    <script>
        let lessonsData = null;
        let currentLesson = null;

        // Convert YouTube URL to embed format
        function getYouTubeEmbedUrl(url) {
            if (!url) return '';

            // Handle different YouTube URL formats
            let videoId = '';
            if (url.includes('youtu.be/')) {
                videoId = url.split('youtu.be/')[1].split('?')[0];
            } else if (url.includes('youtube.com/watch?v=')) {
                videoId = url.split('v=')[1].split('&')[0];
            } else if (url.includes('youtube.com/embed/')) {
                return url; // Already an embed URL
            }

            if (videoId) {
                return `https://www.youtube.com/embed/${videoId}`;
            }

            return url; // Return original if can't parse
        }

        // Load lessons data
        async function loadLessonsData() {
            try {
                const response = await fetch('lessons.json');
                lessonsData = await response.json();
                return lessonsData;
            } catch (error) {
                console.error('Error loading lessons data:', error);
                return null;
            }
        }

        // Get lesson from URL parameter
        function getLessonFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('lesson') || 'lesson1';
        }

        // Find lesson by ID
        function findLessonById(lessonId) {
            if (!lessonsData) return null;
            return lessonsData.lessons.find(lesson => lesson.id === lessonId);
        }

        // Render lesson content
        function renderLesson(lesson) {
            if (!lesson) {
                document.getElementById('lessonContent').innerHTML = '<div class="alert alert-danger">Lesson not found!</div>';
                return;
            }

            // Update page title
            const pageTitle = document.getElementById('pageTitle');
            const lessonTitle = document.getElementById('lessonTitle');
            const lessonSubtitle = document.getElementById('lessonSubtitle');
            const lessonStatus = document.getElementById('lessonStatus');
            const statusBadge = document.getElementById('lessonStatusBadge');

            if (pageTitle) pageTitle.textContent = `${lesson.title} - Educational Hub`;
            if (lessonTitle) lessonTitle.textContent = lesson.title;
            if (lessonSubtitle) lessonSubtitle.textContent = lesson.subtitle;
            if (lessonStatus) lessonStatus.textContent = lesson.statusText;

            // Update status badge
            if (statusBadge) {
                statusBadge.textContent = lesson.statusText;
                statusBadge.className = `badge ${getStatusBadgeClass(lesson.status)}`;
            }

            // Render lesson content
            renderLessonContent(lesson);
            renderLessonActions(lesson);
        }

        // Get status badge class based on status
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'completed': return 'bg-success';
                case 'in-progress': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }

        // Render lesson content sections
        function renderLessonContent(lesson) {
            const contentContainer = document.getElementById('lessonContent');
            let contentHTML = '';

            // Learning Objectives
            contentHTML += `
                <div class="card shadow-soft mb-4">
                    <div class="card-body">
                        <h3 class="card-title mb-4">
                            <i class="fas fa-lightbulb text-${getStatusColor(lesson.status)} me-2"></i>Learning Objectives
                        </h3>
                        <ul class="list-unstyled">
                            ${lesson.objectives.map(obj => `
                                <li class="mb-2">
                                    <i class="fas fa-${lesson.status === 'completed' ? 'check' : 'clock'} text-${lesson.status === 'completed' ? 'success' : 'muted'} me-2"></i>
                                    ${obj}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `;

            // Render sections
            lesson.sections.forEach(section => {
                contentHTML += renderSection(section);
            });

            contentContainer.innerHTML = contentHTML;
        }

        // Render individual section
        function renderSection(section) {
            switch (section.type) {
                case 'text':
                    return `
                        <div class="card shadow-soft mb-4">
                            <div class="card-body">
                                <h4 class="mb-3">${section.title}</h4>
                                <p>${section.content}</p>
                            </div>
                        </div>
                    `;

                case 'technologies':
                    return `
                        <div class="card shadow-soft mb-4">
                            <div class="card-body">
                                <h4 class="mb-3">${section.title}</h4>
                                <div class="row mt-4">
                                    ${section.content.map(tech => `
                                        <div class="col-md-4 mb-3">
                                            <div class="text-center p-3 border rounded">
                                                <i class="${tech.icon} fa-2x ${tech.color} mb-2"></i>
                                                <h6>${tech.name}</h6>
                                                <p class="small text-muted">${tech.description}</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;

                case 'projects':
                    return `
                        <div class="card shadow-soft mb-4">
                            <div class="card-body">
                                <h4 class="mb-3">${section.title}</h4>
                                <p>This lesson focuses on applying your knowledge to real-world scenarios.</p>
                                <div class="row mt-4">
                                    ${section.content.map(project => `
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <h6><i class="${project.icon} ${project.color} me-2"></i>${project.name}</h6>
                                                    <p class="small text-muted">${project.description}</p>
                                                    <div class="progress" style="height: 4px;">
                                                        <div class="progress-bar ${project.color.replace('text-', 'bg-')}" style="width: ${project.progress}%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;

                case 'accordion':
                    return `
                        <div class="card shadow-soft mb-4">
                            <div class="card-body">
                                <h4 class="mb-3">${section.title}</h4>
                                <div class="accordion" id="lessonAccordion">
                                    ${section.content.map((item, index) => `
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                                                    ${item.title}
                                                </button>
                                            </h2>
                                            <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" data-bs-parent="#lessonAccordion">
                                                <div class="accordion-body">
                                                    <p>${item.description}</p>
                                                    ${item.type === 'video' && item.link ? `
                                                        <div class="ratio ratio-16x9 mb-3">
                                                            <iframe src="${getYouTubeEmbedUrl(item.link)}" title="${item.title}" allowfullscreen></iframe>
                                                        </div>
                                                        <a href="${item.link}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                            <i class="fab fa-youtube me-1"></i>Watch on YouTube
                                                        </a>
                                                    ` : item.type === 'article' && item.link ? `
                                                        <a href="${item.link}" target="_blank" class="btn btn-primary btn-sm">
                                                            <i class="fas fa-external-link-alt me-1"></i>Read Article
                                                        </a>
                                                    ` : item.code ? `<pre><code>${item.code}</code></pre>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;

                case 'best-practices':
                    return `
                        <div class="card shadow-soft mb-4">
                            <div class="card-body">
                                <h4 class="mb-3">${section.title}</h4>
                                <div class="row">
                                    ${section.content.map(practice => `
                                        <div class="col-md-6">
                                            <h6><i class="fas fa-code text-primary me-2"></i>${practice.title}</h6>
                                            <ul class="small">
                                                ${practice.items.map(item => `<li>${item}</li>`).join('')}
                                            </ul>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;

                default:
                    return `
                        <div class="card shadow-soft mb-4">
                            <div class="card-body">
                                <h4 class="mb-3">${section.title}</h4>
                                <p>${section.content}</p>
                            </div>
                        </div>
                    `;
            }
        }

        // Render lesson actions (exercise-only completion)
        function renderLessonActions(lesson) {
            const actionTitle = document.getElementById('actionTitle');
            const actionDescription = document.getElementById('actionDescription');
            const actionButtons = document.getElementById('actionButtons');

            actionTitle.textContent = 'Submit Exercise to Complete';
            actionDescription.textContent = 'Complete this lesson by submitting your exercise.';

            // Render action buttons
            let buttonsHTML = '';

            // Exercise button only
            if (lesson.actions.exercise) {
                buttonsHTML += `
                    <button class="btn btn-outline-info" onclick="${lesson.actions.exercise.onclick}">
                        <i class="fas fa-paper-plane me-2"></i>${lesson.actions.exercise.text}
                    </button>
                `;
            }

            actionButtons.innerHTML = buttonsHTML;
        }

        // Get status color
        function getStatusColor(status) {
            switch (status) {
                case 'completed': return 'success';
                case 'in-progress': return 'warning';
                default: return 'muted';
            }
        }

        // Initialize lesson
        async function initLesson() {
            const lessonId = getLessonFromURL();
            const data = await loadLessonsData();

            if (data) {
                const lesson = findLessonById(lessonId);
                currentLesson = lesson;
                renderLesson(lesson);
            } else {
                document.getElementById('lessonContent').innerHTML = '<div class="alert alert-danger">Error loading lesson data!</div>';
            }
        }

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDd77LjKa3wuaumWHtYhN_3tsVpD99juK0",
            authDomain: "ggt-2025.firebaseapp.com",
            projectId: "ggt-2025",
            storageBucket: "ggt-2025.firebasestorage.app",
            messagingSenderId: "822726025795",
            appId: "1:822726025795:web:4e059a32a26e5bc336eaf6",
            measurementId: "G-72DQBYXSVN"
        };

        // Initialize Firebase
        let db = null;
        let auth = null;

        // Initialize Firebase (always real, even on localhost)
        function initializeFirebase() {
            if (typeof firebase === 'undefined') return;
            if (!firebase.apps || !firebase.apps.length) {
                try { firebase.initializeApp(firebaseConfig); } catch (e) { /* ignore if already initialized */ }
            }
            db = firebase.firestore();
            auth = firebase.auth();
        }

        // Get current user ID from Netlify Identity or Firebase Auth
        function getCurrentUserId() {
            // Check Netlify Identity first
            if (window.netlifyIdentity && window.netlifyIdentity.currentUser()) {
                return window.netlifyIdentity.currentUser().id;
            }

            // Check Firebase Auth
            if (auth && auth.currentUser) {
                return auth.currentUser.uid;
            }

            // Demo mode fallback
            return 'demo-user-id';
        }

        // Get current user email
        function getCurrentUserEmail() {
            // Check Netlify Identity first
            if (window.netlifyIdentity && window.netlifyIdentity.currentUser()) {
                return window.netlifyIdentity.currentUser().email;
            }

            // Check Firebase Auth
            if (auth && auth.currentUser) {
                return auth.currentUser.email;
            }

            // Demo mode fallback
            return 'student@gmail.com';
        }

        // Save student progress to Firebase
        async function saveStudentProgress(lessonId, action, data = {}) {
            try {
                const userId = getCurrentUserId();
                const userEmail = getCurrentUserEmail();
                const progressData = {
                    lessonId: lessonId,
                    action: action,
                    data: data,
                    timestamp: new Date().toISOString(),
                    userId: userId,
                    userEmail: userEmail
                };

                // Save to Firebase
                await db.collection('studentProgress').add(progressData);

                // Also update lesson status
                await updateLessonStatus(userId, userEmail, lessonId, action);

                console.log('Progress saved:', progressData);
            } catch (error) {
                console.error('Error saving progress:', error);
            }
        }

        // Update lesson status for user
        async function updateLessonStatus(userId, userEmail, lessonId, action) {
            try {
                const userProgressRef = db.collection('userProgress').doc(userId);
                const doc = await userProgressRef.get();

                if (doc.exists) {
                    const userData = doc.data();
                    if (!userData.lessons) {
                        userData.lessons = {};
                    }

                    if (action === 'lesson_completed') {
                        userData.lessons[lessonId] = {
                            status: 'completed',
                            completedAt: new Date().toISOString()
                        };
                    } else if (action === 'lesson_started') {
                        userData.lessons[lessonId] = {
                            status: 'in-progress',
                            startedAt: new Date().toISOString()
                        };
                    }

                    userData.lastUpdated = new Date().toISOString();
                    await userProgressRef.update(userData);
                } else {
                    const newUserData = {
                        userId: userId,
                        email: userEmail,
                        lessons: {
                            [lessonId]: {
                                status: action === 'lesson_completed' ? 'completed' : 'in-progress',
                                [action === 'lesson_completed' ? 'completedAt' : 'startedAt']: new Date().toISOString()
                            }
                        },
                        createdAt: new Date().toISOString(),
                        lastUpdated: new Date().toISOString()
                    };
                    await userProgressRef.set(newUserData);
                }
            } catch (error) {
                console.error('Error updating lesson status:', error);
            }
        }

        // Get user's lesson status
        async function getUserLessonStatus(lessonId) {
            try {
                const userId = getCurrentUserId();
                const userProgressRef = db.collection('userProgress').doc(userId);
                const doc = await userProgressRef.get();

                if (doc.exists) {
                    const userData = doc.data();
                    return userData.lessons && userData.lessons[lessonId] ? userData.lessons[lessonId].status : 'not-started';
                }
                return 'not-started';
            } catch (error) {
                console.error('Error getting lesson status:', error);
                return 'not-started';
            }
        }

        // Restart lesson function
        function restartLesson(lessonId) {
            saveStudentProgress(lessonId, 'lesson_restarted');
            showAlert('Lesson restarted! You can now start fresh.', 'info');
            // Reload the page to reset the lesson
            window.location.reload();
        }

        // Override the markLessonComplete function to save to Firebase
        function markLessonComplete(lessonId) {
            requireAuth(() => {
                saveStudentProgress(lessonId, 'lesson_completed');
                updateStudentProgress('lesson_completed', { lessonId: lessonId });
                showAlert('Lesson marked as complete!', 'success');
            });
        }

        // Check Firebase connectivity (read-only)
        async function checkFirebaseConnectivity() {
            try {
                if (typeof firebase === 'undefined') {
                    console.warn('Firebase SDK not loaded');
                    if (typeof showAlert === 'function') showAlert('Firebase SDK not loaded', 'warning');
                    return false;
                }
                if (!firebase.apps || !firebase.apps.length) {
                    console.warn('Firebase app not initialized');
                    if (typeof showAlert === 'function') showAlert('Firebase app not initialized', 'warning');
                    return false;
                }
                if (db && typeof db.collection === 'function') {
                    // In demo mode, our mock does not support limit().get(), so just call collection
                    if (typeof db.collection('diagnostics').limit === 'function') {
                        await db.collection('diagnostics').limit(1).get();
                    } else {
                        await db.collection('diagnostics').get?.();
                    }
                    console.log('Firebase Firestore connectivity: OK');
                    if (typeof showAlert === 'function') showAlert('Connected to Firebase', 'success');
                    return true;
                } else {
                    console.log('Firebase app initialized (no Firestore check)');
                    if (typeof showAlert === 'function') showAlert('Firebase app initialized', 'info');
                    return true;
                }
            } catch (err) {
                console.error('Firebase connectivity check failed:', err);
                if (typeof showAlert === 'function') showAlert('Firebase connection failed. See console.', 'danger');
                return false;
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function () {
            initializeFirebase();
            initLesson();
            setTimeout(checkFirebaseConnectivity, 300);
        });
    </script>
</body>

</html>